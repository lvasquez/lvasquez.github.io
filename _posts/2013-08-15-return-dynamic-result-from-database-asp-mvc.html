---
layout: post
title: Return Dynamic Result from Database ASP MVC
comments: true
categories:
- ASP MVC
tags:
- ASP MVC
- Dynamic Pivot
- Dynamic Result
- Sql Server 2008
status: publish
type: post
published: true
comments: true
description: Working to Dynamic Pivot from Store Procedure of SQL Server to ASP MVC
meta:
  geo_public: '0'
  publicize_twitter_user: levb20
  _wpas_skip_922231: '1'
---
This is a little example how to return dynamic result from database to a Razor View. The question is? when I can use this or in where case? well, basically when someone request an specific report that you need to use a pivot table, with Crystal Reports is really easy, Crystal does it for you with drag and drop, but if you want to retrieve the data only for display in a view, you can do this:
Using the NorthWind database, generate a Stored Procedure that returns the dynamic pivot table like this:

{% highlight sql %}
USE [Northwind]
GO
/****** Object:  StoredProcedure [dbo].[DynamicPivot]    Script Date: 08/15/2013 18:41:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[DynamicPivot]
AS
--pivot dinÃ¡mico
DECLARE @CatPVT AS NVARCHAR(MAX), @Categorias AS varchar(20)
DECLARE @CatID INT
SET @CatID=(SELECT MIN(CategoryID) FROM Categories)
SET @Categorias = ( SELECT CategoryName FROM Categories WHERE CategoryID = @CatID)
SET @CatPVT = N''
WHILE @Categorias IS NOT NULL
BEGIN
  SET @CatPVT = @CatPVT + N',['+ @Categorias +N']'
  SET @Categorias = (SELECT TOP(1) CategoryName
                     FROM Categories WHERE CategoryID > @CatID
                     ORDER BY CategoryID ASC)
  SET @CatID=(SELECT MIN(CategoryID) FROM Categories Where Categoryname=@Categorias)
END
SET @CatPVT = SUBSTRING(@CatPVT, 2, LEN(@CatPVT))

DECLARE @sql AS nvarchar(MAX)
SET @sql = N'SELECT *
            FROM (SELECT P.ProductName, C.CategoryName, (OD.UnitPrice * OD.Quantity) AS Monto
                  FROM Products P
                    INNER JOIN dbo.[Order Details] OD
                        ON P.ProductID=OD.ProductID
                    INNER JOIN Categories C
                    ON C.CategoryID=P.CategoryID
            ) PIV
            PIVOT (SUM(Monto) FOR  CategoryName IN ('+ @CatPVT  + ')) AS Child'

EXEC sp_executesql @sql

{% endhighlight %}
Then we could use a raw SQL query because EF doesn't support if you want to use dynamic query context, and we can make using TypeBuilder option and ExpandoObject object. It has little performance overhead with this:
-- Repository Services

{% highlight csharp %}
public List<Dictionary<string, object>> Read(DbDataReader reader)
{
 List<Dictionary<string, object>> expandolist = new List<Dictionary<string, object>>();
 foreach (var item in reader)
 {
   IDictionary<string, object> expando = new ExpandoObject();
   foreach (PropertyDescriptor propertyDescriptor in TypeDescriptor.GetProperties(item))
   {
   	 var obj = propertyDescriptor.GetValue(item);
	 expando.Add(propertyDescriptor.Name, obj);
   }
   expandolist.Add(new Dictionary<string, object>(expando));
 }
return expandolist;
}
{% endhighlight %}
so now, with this we have a "Dictionary" object from dynamic object and using it you can work easily at design time rather then wait until runtime using "dynamic" object. I'm using Dependency Injection with Unity as a IoC, so in my controller I get this:
-- Controller
{% highlight csharp %}
public ActionResult DynamicIndex()
{
  using (var ctx = new NorthwindEntities())
  using (var cmd = ctx.Database.Connection.CreateCommand())
  {
	ctx.Database.Connection.Open();
	cmd.CommandText = "EXEC DynamicPivot";
	using (var reader = cmd.ExecuteReader())
	{
	  var model = this._productsServices.Read(reader).ToList();
	  return View(model);
	}
  }
}
{% endhighlight %}
and finally in so at the view end i can get name of this dynamic properties with Value like this:
{% highlight csharp %}
@model List<Dictionary<string, object>>
@{
ViewBag.Title = "DynamicIndex";
Layout = "~/Views/Shared/_Layout.cshtml";
}
<h2>Dynamic Data</h2>
<table class="table table-bordered">
 @foreach (var row in Model.FirstOrDefault())
 {
	<th>@row.Key</th>
 }
 @foreach (var row in Model)
 {
	<tr>
	  @foreach (var column in row)
	  {
		<td>@column.Value</td>
	  }
	</tr>
  }
</table>
{% endhighlight %}

and you got this:
</br>
<a href="http://lvasquezdotcom.files.wordpress.com/2013/08/dynamicdata.jpg"><img src="http://lvasquezdotcom.files.wordpress.com/2013/08/dynamicdata.jpg" alt="DynamicData" width="963" height="587" class="aligncenter size-full wp-image-242" /></a>
</br>
has you can see, this is a easy way to do this with a little performance, clean code and reusable code, hope it helps
</br>
references:
</br>
<a href="http://stackoverflow.com/questions/15732340/database-context-and-return-dynamic-result-set-in-asp-net-mvc" target="_blank">http://stackoverflow.com/questions/15732340/database-context-and-return-dynamic-result-set-in-asp-net-mvc</a>
</br>
<a href="http://geeks.ms/blogs/ozonicco/archive/2007/12/28/implementaci-243-n-de-pivot-din-225-mico.aspx" target="_blank">http://geeks.ms/blogs/ozonicco/archive/2007/12/28/implementaci-243-n-de-pivot-din-225-mico.aspx</a>
