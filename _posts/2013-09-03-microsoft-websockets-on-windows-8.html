---
layout: post
title: Microsoft Websockets on Windows 8
comments: true
categories:
- WebSockets
tags:
- ASP.NET 4.5
- C++
- Microsoft
- Microsoft.Websockets
- Websockets
- Windows 8
status: publish
type: post
published: true
comments: true
description: Example with Microsoft Web Sockets on Windows 8
meta:
  publicize_twitter_user: levb20
  _wpas_skip_922231: '1'
---
<p>
This is a little example that i found about one of the new features support of Windows 8 and that's a native support for Websockets on server side. At the end of the post, i put some references about why websockets, the original code example, the websockets api client documentation, etc... and you can download the sourcecode of this example for <a href="https://github.com/lvasquez/Microsoft-WebSockets-Example" target="_blank">here!!</a>

So first we need to preparate the server side.

Note: On the server side, we can host our WebSocket server through any one of the ways below:
<ul>
	<li>Using <code>HttpContext.AcceptWebSocketRequest</code></li>
	<li>Creating a <strong>WCF</strong> service with <strong> <code>CallbackContract</code> </strong>and the new <code>netHttpBinding</code></li>
	<li>Using <strong><code>WebSocketHandler</code> </strong>or <strong> </strong><code>WebSocketHost</code> provided in <em><strong>Microsoft.WebSockets.dll</strong></em></li>
</ul>
<p>
On the client web side, HTML 5 provides WebSocket APIs and <strong>jQuery </strong> wraps those APIs for easier usage.
</p>
<p>
If we want to create a client side application, we can do that through either of the ways below:
<ul>
	<li>Using the <code>ClientWebSocket</code> class (<code>System.Net.WebSockets</code>).</li>
	<li>Creating a <strong>WCF </strong>client and referencing the WCF service which supports WebSocket connection.</li>
</ul>
</p>
<p>
<strong>NOTE</strong>: We can only use .NET WebSocket on <strong>Windows 8</strong>, <strong>Windows Server 2012</strong> and above, including both server-side and client-side applications. And the web server must be <strong>IIS 8</strong> and above. IIS 8 <code><em>Express</em></code> which is also packaged in Visual Studio 2012 does NOT support WebSocket at present. I hope Microsoft will add support in future.
</p>
<p>
HTML 5 WebSocket API has no limitation on OS platform. The only limitation is the browser versions. Internet Explorer started supporting HTML 5 WebSocket since <strong>IE 10</strong>.

To enable WebSocket on the server side, you need to install <strong>WebSocket Protocol</strong> for <strong>IIS 8</strong>. On Windows Server 2012, you could do that through <strong>Server Manager</strong> ->;<strong> Manage</strong> ->; <strong>Add Roles and Features</strong>. Expand the <strong>Web Server (IIS)</strong> role and check <strong>Web Server</strong> ->; <strong>Application Development</strong> ->;<strong> WebSocket Protocol</strong>. You may be asked to install dependencies and just allow them. Then install all your selections. <strong>Windows 8</strong> should be similar.
</br>
<center>
<a href="http://lvasquezdotcom.files.wordpress.com/2013/09/websockrt.jpg"><img src="http://lvasquezdotcom.files.wordpress.com/2013/09/websockrt.jpg" alt="websockrt" width="616" height="665" class="aligncenter size-full wp-image-306" /></a>
</center>
</br>
<p>
And now we can start to our project, first we need to create a ASP.NET Empty Web Application Project and in the Manage Nuget Packages search and install the Microsoft.Websockets package, also you can write the name of the nuget package in the Package Manager Console
</p>
</p>
{% highlight text %}
PM>; Install-Package Microsoft.WebSockets 
{% endhighlight %}
<p>
so then we need to create out HttpHandler for intercepting requests made to your ASP.NET web application server
and create a synchronous handler inheriting of IHttpHandler
</p>
{% highlight c# %}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;

using Microsoft.Web.WebSockets;

namespace WebSocketExample
{
    /// <summary>;
    /// Summary description for WSHttpHandler
    /// </summary>;
    public class WSHttpHandler : IHttpHandler
    {

        public void ProcessRequest(HttpContext context)
        {
            if (context.IsWebSocketRequest)
                context.AcceptWebSocketRequest(new MySocketHandler());
        }

        public bool IsReusable
        {
            get
            {
                return false;
            }
        }
    }
}
{% endhighlight %}
<p>
the we need to create a class that inherits from WebSocketHandler and create our sockets methods
</p>
{% highlight csharp %}
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using Microsoft.Web.WebSockets;

namespace WebSocketExample
{
    public class MySocketHandler : WebSocketHandler
    {
        private static WebSocketCollection clients = new WebSocketCollection();
        private string name;

        public override void OnOpen()
        {
            this.name = this.WebSocketContext.QueryString["name"];
            clients.Add(this);
            clients.Broadcast(name + " has connected.");
        }

        public override void OnMessage(string message)
        {
            clients.Broadcast(string.Format("{0} said: {1}", name, message));
        }


        public override void OnClose()
        {
            clients.Remove(this);
            clients.Broadcast(string.Format("{0} has gone away", name));
        }
    }
}
{% endhighlight %}
<p>
and finally our view with a html file
</p>
{% highlight html %}
<!DOCTYPE html/>;
<html xmlns="http://www.w3.org/1999/xhtml;"/>
<head>
    <title>WebSocket Example</title>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.10.2.min.js"></script>

    <script type="text/javascript">

        $(document).ready(function () {

            var name = prompt('what is your name?:');
            var url = 'ws://localhost:49941/WSHttpHandler.ashx' + '?name=' + name;

            alert('Connecting to: ' + url);

            ws = new WebSocket(url);

            ws.onopen = function () {

                $('#messages').prepend('Connected <br/>;');

                $('#cmdSend').click(function () {
                    ws.send($('#txtMessage').val());
                    $('#txtMessage').val('');
                });
            };

            ws.onmessage = function (e) {
                $('#chatMessages').prepend(e.data + '<br/>;');
            };

            $('#cmdLeave').click(function () {
                ws.close();
            });

            ws.onclose = function () {
                $('#chatMessages').prepend('Closed <br/>;');
            };

            ws.onerror = function (e) {
                $('#chatMessages').prepend('Oops something went wront <br/>;');
            };

        });

</script>
</head>
<body>
     <input id="txtMessage" />
     <input id="cmdSend" type="button" value="Send" />
     <input id="cmdLeave" type="button" value="Leave" />
     <br />
     <div id="chatMessages" />
</body>
</html>
{% endhighlight %}
<p>
and you get this:
<center>
<img alt="websockets" src="/images/websockets.jpg">
</center>
<p>
so as you see in the html file the client web side, HTML 5 provides WebSocket APIs and jQuery wraps those APIs for easier usage.
</p>
</br>
</br>

References:
<ul>
<li><a href="http://msdn.microsoft.com/en-us/magazine/jj863133.aspx" target="_blank">http://msdn.microsoft.com/en-us/magazine/jj863133.aspx</a></li>
<li><a href="http://weblogs.asp.net/dwahlin/archive/2013/04/13/building-an-html5-web-sockets-server-with-asp-net-4-5.aspx" target="_blank">http://weblogs.asp.net/dwahlin/archive/2013/04/13/building-an-html5-web-sockets-server-with-asp-net-4-5.aspx</a></li>
<li><a href="http://www.jefclaes.be/2011/01/html5-installing-microsoft-websockets.html" target="_blank">http://www.jefclaes.be/2011/01/html5-installing-microsoft-websockets.html</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/ie/hh673567%28v=vs.85%29.aspx" target="_blank">http://msdn.microsoft.com/en-us/library/ie/hh673567%28v=vs.85%29.aspx</a></li>
<li><a href="http://alexjmackey.wordpress.com/2012/05/01/websockets-with-asp-net-4-5-and-visual-studio-11/" target="_blank">http://alexjmackey.wordpress.com/2012/05/01/websockets-with-asp-net-4-5-and-visual-studio-11/</a></li>
</ul>
</p>